---
title: "Exposure and Fixed-Effects modelling "
output: html_notebook
---

# Introduction

This aim of this research is to build a series of models which include the following response variables: 

1. Male age-standardised mortality rates (all-cause)
2. Female age-standardised mortality rates (all-cause)
3. Relative difference in all-cause rates (1 / 2)
4. Absolute difference in all-cause rates (1 - 2) 
5. Male age-standardised mortality rates (NCDs)
6. Female age-standardised mortality rates (NCDs)
7. Relative difference in NCD rates (5 / 6)
8. Absolute differnece in NCD rates (5 - 6)

This will be done for each country (level 3 in location hierarchy). 

And a series of exposures from the World Bank will be used: 

1. GDP per cap by purchasing power parity 
2. Male literacy rates 
3. Female literacy rates 
4. etc etc 

# Loading GBD data 


- Source is [here](http://s3.healthdata.org/gbd-api-2016-production/3f1a784fe33bf6d9447c7b90e8828c3f_files/IHME-GBD_2016_DATA-3f1a784f-1.zip)


```{r}
require(tidyverse)
source("download_completed_request.R")
```

Will `read_csv_directly` work?

```{r, eval = F}
asr_dta <- read_csv_directly(
  url_loc = "http://s3.healthdata.org/gbd-api-2016-production/3f1a784fe33bf6d9447c7b90e8828c3f_files/IHME-GBD_2016_DATA-3f1a784f-1.zip",
  csv_name = "data/age_standardised/age_standardised.csv")

```

This *will not* work anymore, I think because the zip file contains two files: a csv file, and a citation.txt file. 

* Action: amend read_csv_directly for new behaviour from GHDx.


Anyway, the data's now in the right place

```{r}
asr_data <- read_csv("data/age_standardised/IHME-GBD_2016_DATA-3f1a784f-1.csv")
glimpse(asr_data)
```

Now to link this to the hierarchy 


```{r}

gbd_locations <- readxl::read_excel("raw_data/IHME_GBD_2016_CODEBOOK/IHME_GBD_2016_GBD_LOCATION_HIERARCHY_Y2018M04D26.XLSX")

gbd_country_ids <- gbd_locations %>% 
  filter(location_id %in% 1:218) %>% 
  filter(level == 3) %>% 
  pull(location_id)

asr_data %>% 
  filter(location_id %in% gbd_country_ids) %>% 
  filter(measure_name == "Deaths") %>% 
  select(location = location_name, year, sex = sex_name, cause = cause_name, std_mort_rate = val) -> mort_rate_data

asr_data %>% 
  filter(location_id %in% gbd_country_ids) %>% 
  filter(measure_name == "DALYs (Disability-Adjusted Life Years)") %>% 
  select(location = location_name, year, sex = sex_name, cause = cause_name, std_mort_rate = val) -> daly_rate_data

```

And now to join this to the world bank measures 

```{r}
wb_data <- read_rds("data/world_bank/extracted_indicators.RData")

```

Let's also add GDP per capita to the selection


```{r, cache = T}
gdp_percap_data <- wbstats::wb(indicator= "NY.GDP.PCAP.PP.CD") %>% as_tibble()

wb_data <- bind_rows(wb_data, gdp_percap_data)
rm(gdp_percap_data)
```

```{r}
mort_rate_data_joined <- mort_rate_data %>%
  mutate(country = location) %>% 
  inner_join(
    wb_data %>% 
      mutate(year = as.integer(date)) %>% 
      select(year, country, indicator_id = indicatorID, indicator, indicator_value = value) 
  ) 

```


As a first example, let's regress rates on `5.51.01.07.gender` (Gender equality in education)

```{r}
summary(lm(rate ~ sex + year, data = wb_gbd_joined))

summary(lm(rate ~ sex + year + indicator_value, data = wb_gbd_joined %>% filter(indicator_id == "5.51.01.07.gender")))

```


Now on GDP per capita

